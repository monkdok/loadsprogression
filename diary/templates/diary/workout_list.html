{% extends 'diary/base.html' %}
{% load humanize %}


{% block title %}
Workouts - {{ block.super }}
{% endblock %}

{% block content %}

{% for workout in workouts %}

<!--Workout button-->
<div class="row">
    <div class="col-12">
        <div class="btn-group btn-lg btn-block">
            <a href="{% url 'exercise_list' workout.slug %}" type="button" class="btn btn-warning btn-lg btn-block" id="title{{ workout.slug }}">{{ workout.title }}</a>
            <button type="button" class="btn btn-warning dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-ellipsis-v"></i>
            </button>

            <!--Dropdown menu-->
            <div class="dropdown-menu">
                <button type="button" class="dropdown-item" data-toggle="modal" data-target="#edit{{ workout.slug }}" id="{{ workout.slug }}">Edit</button>
                <div class="dropdown-divider"></div>
                <button type="button" class="dropdown-item" data-toggle="modal" data-target="#workout_delete{{ workout.slug }}">Delete</button>
            </div>
        </div>
    </div>
</div>
{% include 'diary/modals/workout_update_modal.html' %}
{% include 'diary/modals/workout_delete_modal.html' %}


{% endfor %}

<!--Modal form-->
{% include 'diary/modals/workout_create_modal.html' %}
<div class="row">
    <div class="col">
        {% if workouts_len == 0 %}
        <div class="row">
            <div class="col-8 offset-2">
                <span class="badge badge-primary" style="font-size:30px">
                Create you first Workout<br>
                <span style="font-size:22px">for example: "Leg day"</span><br>
                </span>
            </div>
        </div>
        {% endif %}
        <p>
            <button type="button" class="btn btn-outline-dark mt-4" data-toggle="modal" data-target="#workout_create" data-backdrop="false" id="js-add-workout">Add workout</button>
        </p>

    </div>
</div>

<script>
    $(document).ready(function(){
        // Create workout
        $("#workout-create-form").on('submit', function(e) {
            e.preventDefault();
            // let workoutTitle = $('input#workout-create-title').val()
            let workoutTitle = $('input#workout-create-title').val()
            console.log(workoutTitle)
            $.ajax({
                url: "{% url 'workout_list_url' %}",
                // data: form.serialize(),
                data: {title: workoutTitle, csrfmiddlewaretoken: '{{ csrf_token }}'},
                type: 'POST',
                dataType: 'json',
                success: function (data) {
                    if (data.form_is_valid) {
                        $('.modal-backdrop').remove();
                        let html2 = document.querySelector('html')
                        $("body").html(data.html);
                        $('.dropdown-toggle').dropdown();
                        $('body').removeClass('modal-open');

                    }
                    else {
                        // $("#workout_create .modal-body").html(data.workouts_create_form);
                        console.log('Nope')

                    }
                }
            });
        });

        //Update workout
        $('div.dropdown-menu > button').on('click', function () {
            if (this.textContent === 'Edit') {
                let parEl = this.parentElement.parentElement
                let workoutTitle = parEl.firstElementChild.textContent
                let workoutUpdateModalId = 'edit' + this.id
                let workoutInput = $('input#workout-update-title')
                console.log('before:', workoutTitle)
                if (workoutInput) {
                    let modalBody = $('.modal-body')
                    let modalBodyInput = $('.modal-body > input')
                    $(modalBody).empty().append(`<input type="text" name="title" class="form-control" id="workout-update-title" value="${workoutTitle}">`)
                }

                // $('input#workout-update-title').keyup(function(){
                //     let desc = $( 'input#workout-update-title' ).val();
                //     alert(desc);
                // });
                $("form#workout-update-form").submit(function(s) {
                    s.preventDefault()
                    let url = $(this).attr('action')
                    let workoutTitle = $('#workout-update-title').attr('value')
                    let type = $(this).attr('type')

                    console.log('after:', workoutTitle)
                    console.log('url:', url)
                    console.log('this:', this)
                    $.ajax({
                        url: url,
                        data: {title: workoutTitle, csrfmiddlewaretoken: '{{ csrf_token }}'},
                        type: type,
                        dataType: 'json',
                        success: function (data) {
                            alert('Success')
                            if (data.form_is_valid) {
                                // $('.modal-backdrop').hide();
                                // $(document.body).removeClass("modal-open");
                                // $('#workout_create').modal('hide')
                                // $('.modal').remove();
                                $('.modal-backdrop').remove();
                                // $('#workout_create').modal('handleUpdate')
                                // $('body').removeClass('modal-open');
                                // document.documentElement.innerHTML = data.html; // 3 dots don't load
                                let html2 = document.querySelector('html')
                                // html2.innerHTML = data.html
                                $("body").html(data.html);
                                $('.dropdown-toggle').dropdown();
                                $('body').removeClass('modal-open');

                            }
                            else {
                                // $("#workout_create .modal-body").html(data.workouts_create_form);
                                console.log('Nope')

                            }
                        }
                    });

                });
            }
        })
    });
</script>

<input type="text" value="PinkTie" id="txtDesc"/>
<button id="button" onclick="updateDesc();">Update</button>



{% endblock %}

